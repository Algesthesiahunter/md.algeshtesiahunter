# tcp为什么需要三次握手

1. 从本质协议出发，tcp是面向连接的，也就是说需要双方连接上才可以进行数据传输，那双方怎么样才算是连接上了呢？最起码要保证通信和客户端和服务端都具有发送数据和接受数据的能力，当客户端第一次发送`syn`报文时可以确定客户端是具有发送数据能力的，这时候还不确定客户端是否具有接收数据的能力以及服务端是否具有接受数据和发送数据的能力，而这也是第一次握手。

2. 当服务端接受到`syn`报文时，这时候是可以确定服务端是具有接受数据能力的，而当服务端回复`syn`和`ack`报文时这时候可以确定服务端是具有发送数据的能力的，这就确定了服务端具有接受数据和发送数据的能力，但是这时候还不确定客户端是否具有接受数据的能力，而这也就是第二次握手。

3. 当客户端接收到服务端的回复时，这个时候可以确定客户端具有接受数据和发送数据的能力，但是这个时候服务器还不知道客户端是否接收到数据，也就是服务端还不确定客户端是否具有接受数据的能力，所以这个时候客户端需要回复一个`ack`报文，也就是第三次握手。也让服务端知道客户端具有接受数据的能力，这从而确定了客户端和服务端是具有双向通工传输数据的能力了。

# tcp四次挥手

1. 主动关闭方发出`fin`报文
2. 被动关闭方回复`ack`报文
3. 被动关闭方发送`fin`报文
4. 主动关闭方回复`ack`报文

1. tcp是双向通风的协议，所以在关闭连接之前必须确保通信和客户端和服务端都已经把数据传输完成了，第一次挥手时，主动关闭方告诉被动关闭方，自己数据传输完成了，已经没有数据可传输了，但是被动关闭方可能还有数据没有传输完成，所以被动关闭方需要发送一个`ack`报文告诉主动关闭方，我已经收到你的`fin`报文了，我知道你没有数据传输了，请等待我把数据传输完成，当被动关闭方把数据传输完成后，给主动帮对方发送一个`fin`报文和`ack`报文，告诉主动关闭方我也没有数据可以传输了，我的数据有传输完成了，你可以准备关闭了，而这也就是第三次挥手，第四次挥手，主动关闭方回复一个`ack`报文，我们告诉被动关闭方，我知道你的数据以及传输完成了，被动关闭方收到`ack`报文后关闭连接，主动关闭方等到一定时间后也关闭连接，为什么这个主动关闭方关闭连接之前，需要等待一定的时间，这是为了确保被动关闭方已经收到`ack`报文了，如果在这等待时间内被动关闭方因为网络不通畅的原因，没有收到`ack`报文而主动关闭，会重发`fin`报文给主动关闭方，而主动关闭方会重发这个`ack`报文，这么做的好处是确保双方的连接都可以顺利关闭，如果没有这个机制保证的话，主动关闭方直接关闭连接，而被动关闭方没有收到`ack`报文，导致一直保持连接，等待主动关闭方发送`ack`报文，这种导致其中一方关闭了，而另一方并没有关闭连接，造成支援的浪费。
